<!DOCTYPE html>
<html>
	<head>
		<meta charset=UTF-8>
		<title>Jimmy's Alt Tag Automator Beta 1.2</title>
		<script
			  src="https://code.jquery.com/jquery-3.6.0.js"
			  integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
			  crossorigin="anonymous">
			</script>
			<script src = "https://cdn.jsdelivr.net/npm/xlsx@0.14.3/dist/xlsx.full.min.js"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js" integrity="sha512-csNcFYJniKjJxRWRV1R7fvnXrycHP6qDR21mgz1ZP55xY5d+aHLfo9/FcGDQLfn2IfngbAHd8LdfsagcCqgTcQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
			<link rel = "stylesheet" href = "stylesheet.css">

			<link rel="preconnect" href="https://fonts.googleapis.com">
			<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
			<link href="https://fonts.googleapis.com/css2?family=Asap:wght@400;600&display=swap" rel="stylesheet">
	</head>
	<body>

		<div class = "bodyWrapper">

			<h1>Jimmy's Autotagger</h1>
			<div class = "wrapper">

				<div>
					<div class = "file-selectors">

						<div id="drop_zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
							<p>Drop XLS here ...</p>
					</div>

					</div>
					<iframe id = "preview" height = "320" width = "480"></iframe>
					<textarea id = "tagBox"></textarea>
					<div class = "buttonPrimary" onclick = "autotag()" id = "tagButton" disabled>TAG IT!</div>
					<div class = "buttonSecondary" onclick = "download()" id = "downloadButton" disabled>Download</div>


				</div>
				<textarea id = "tagList"></textarea>
			</div>
		</div>

		<script>
		function dropHandler(ev) {
			console.log('File(s) dropped');

			// Prevent default behavior (Prevent file from being opened)
			ev.preventDefault();

			if (ev.dataTransfer.items) {
				// Use DataTransferItemList interface to access the file(s)
				for (var i = 0; i < ev.dataTransfer.items.length; i++) {
					// If dropped items aren't files, reject them
					if (ev.dataTransfer.items[i].kind === 'file') {
						var file = ev.dataTransfer.items[i].getAsFile();
						console.log('... file[' + i + '].name = ' + file.name);
						var files = ev.dataTransfer.files;

						if (file.name.includes(".html")) {
							openHTML(file);
						}
						else if (file.name.includes(".xls")) {
							openSheet(file);
						}

						ev.target.style.color = "white";
						ev.target.style.backgroundColor = "#6B9EFF";
						ev.target.style.border = "2px solid #6B9EFF";
					}
				}
			} else {
				// Use DataTransfer interface to access the file(s)
					for (var i = 0; i < ev.dataTransfer.files.length; i++) {

					}
				}
			}

			function dragOverHandler(ev) {
			  console.log('File(s) in drop zone');

			  // Prevent default behavior (Prevent file from being opened)
				ev.target.style = "background: #ECF9FF;border: 2px dashed #CDCDCD;border-radius: 20px;";
				ev.preventDefault();
			}


		</script>

		<script>

			//INSTRUCTIONS: export xls from Badger Feature View
			//Select html and xlsx
			//click 'tag it!'
			//download new html or copy tags over

			//compatibility: tested and working on safari and firefox

			var file_text = "";
			var html_text = "";
			var alt_tags = [];
			var item_names = [];
			var matched_items = [];
			var prices = []; //maybe pull prices and other info from item lists xls?
			var workbook;
			var sheetName;
			var sheet;
			var new_code = "";
			var percent_off = 0;
			

			function openSheet(file) {
				//const [file] = document.getElementById("xls_browser").files;
			  const reader = new FileReader();
				var data = "";

			  reader.addEventListener("load", () => {
			    // this will then display a text file
			    data = reader.result;
					var options = { type: 'array' };
    			workbook = XLSX.read(data, options);
					sheetName = workbook.SheetNames;
    			sheet = workbook.Sheets["featureViewTable"];

					if(sheetName[0] != "featureViewTable") {
						alert("Ensure you are using a feature view table exported from Badger.")
					}
					else {
							var range = XLSX.utils.decode_range(sheet['!ref']);
							matched_items = [];

							//search excel sheet for matches
							for (let rowNum = range.s.r + 1; rowNum <= range.e.r; rowNum++) {
									var iname = sheet[XLSX.utils.encode_cell({r: rowNum, c: 3})]["v"];
									var logo = sheet[XLSX.utils.encode_cell({r: rowNum, c: 4})]["v"];
									var prices = sheet[XLSX.utils.encode_cell({r:rowNum,c:10})]["v"];
									var special_notes = sheet[XLSX.utils.encode_cell({r:rowNum,c:11})]["v"];
									var theirs = "";
									
									//apply discount
									prices = prices.replaceAll("Our Price","OurPrice");
									prices = prices.replaceAll("Their Price","TheirPrice");
									var priceList = prices.split(" ");
									for(var i =0;i<priceList.length;++i) { 
										if(priceList[i].match("OurPrice")){
										var number = Number(priceList[i].replace(/[^0-9\.]+/g,""));
										console.log(number);
										var discount = number * (1-(0.01*percent_off));
										discount = discount.toFixed(2);
										console.log(discount + " discounted");
									}else if(priceList[i].match("TheirPrice")){
										theirs = Number(priceList[i].replace(/[^0-9\.]+/g,""));
									}}

									prices = "Our Price:" + discount + ", theirs: $" + theirs;

									if(!iname.match(logo)) {
										iname = logo + " " + iname;
									}

									prices = prices.replaceAll("rice:","rice: $");
									var tag = iname + ": " + prices;
									matched_items.push(tag);

							}
							

					}
			  }, false);

			  if (file) {
			    reader.readAsArrayBuffer(file);
					document.getElementById("tagButton").disabled = false;
					document.getElementById("downloadButton").disabled = false;
			  }
			}

			function autotag() {
				var tagList = document.getElementById("tagList");
				tagList.value = "";
				for(var i = 0;i<matched_items.length;++i) {
					tagList.value += matched_items[i] + "\n";
				}
			}

			// function openHTML(file) {
			// 	console.log("opening html");
			//   //const [file] = document.getElementById("html_browser").files;
			//   const reader = new FileReader();

			//   reader.addEventListener("load", () => {
			//     // this will then display a text file
			//     html_text = reader.result;
			// 		dummyElement.contentWindow.document.write(html_text);
			//   }, false);

			//   if (file) {
			//     reader.readAsText(file);
			//   }
			// }

			// var dummyElement = document.getElementById("preview");

			// function autotag() {
			// 	dummyElement.src = "";

			// 	var images = [];
			// 	var tagIndex = 0;
			// 	var tagBox = document.getElementById("tagBox");
			// 	var last_item = "";
			// 	tagBox.value = "";

			// 	var range = XLSX.utils.decode_range(sheet['!ref']);
			// 	matched_items = [];

			// 	//search excel sheet for matches
			// 	for (let rowNum = range.s.r + 1; rowNum <= range.e.r; rowNum++) {
			// 			var iname = sheet[XLSX.utils.encode_cell({r: rowNum, c: 3})];
			// 			var prices = sheet[XLSX.utils.encode_cell({r:rowNum,c:10})]["v"];
			// 			var special_notes = sheet[XLSX.utils.encode_cell({r:rowNum,c:11})]["v"];

			// 			//fix prices if in special notes
			// 			if (prices == "" && special_notes.toLowerCase().includes("price")) {
			// 				console.log("special notes located");
			// 				prices = special_notes;
			// 			}

			// 			iname = iname["v"].replace(" (logo) "," ");
			// 			var complete_tag = iname + ": " + prices + ".";
			// 			complete_tag = complete_tag.replaceAll("rice:","rice: $");

			// 			for (var i = 0;i<item_names.length;++i)  {
			// 				if (last_item != iname) {
			// 					//match by size
			// 					if (iname.includes("in ") || iname.includes("\"")) {
			// 						item_names[i] = complete_tag;
			// 						matched_items.push(complete_tag);
			// 						last_item = iname;
			// 					}

			// 					//combined words? ex: water color, watercolor
			// 					if (iname.toLowerCase().includes(item_names[i].toLowerCase().replaceAll(" ","")) ||
			// 				item_names[i].toLowerCase().includes(iname.toLowerCase().replaceAll(" ",""))) {
			// 						item_names[i] = complete_tag;
			// 						matched_items.push(complete_tag);
			// 						last_item = iname;
			// 					}

			// 					if (iname.toLowerCase().includes(item_names[i].toLowerCase())) {
			// 						//match by containing name
			// 						item_names[i] = complete_tag;
			// 						matched_items.push(complete_tag);
			// 						last_item = iname;
			// 					}

			// 					//match by last word in description
			// 					var split_name = iname.toLowerCase().split(" ");
			// 					if (item_names[i].includes(split_name[split_name.length-1]) && last_item!=iname) {

			// 						item_names[i] = complete_tag;
			// 						matched_items.push(complete_tag);
			// 						last_item = iname;
			// 						console.log("split name located");
			// 					}
			// 				}
			// 			}

			// 	}

			// 	//add matched items to textarea for copying
			// 	for (var i = 0;i < item_names.length;++i) {
			// 			var prettyTag = item_names[i];
			// 			document.getElementById("tagList").value += prettyTag + "\n";
			// 	}

			// 	//read image names
			// 	var elements = dummyElement.contentWindow.document.getElementsByTagName("img");
			// 	for (var i = 0;i < elements.length;++i) {

			// 			//check if item image
			// 			if (elements[i].width == "320" || elements[i].width == "640") {
			// 				elements[i].setAttribute("alt", alt_tags[tagIndex]);
			// 				var path = elements[i].src.toString().split("/");
			// 				var item_name = path[path.length-1].replace(".png","").replaceAll("_"," ").replace("320x220","").replace("640x100","").replace("640x200","").trim();
			// 				//	+ ": OUR PRICE " + ", theirs " + ".";
			// 				item_name = item_name.charAt(0).toUpperCase() + item_name.slice(1);

			// 				//remove duplicates
			// 				if (item_name != last_item && !item_name.includes("full")) {
			// 					item_names.push(item_name);
			// 					tagBox.value += item_name + "\n";
			// 				}

			// 				last_item = item_name;
			// 				++tagIndex;
			// 			}

			// 	}

			// 	//these are ordered, matched items are unordered
			// 	console.log(item_names);

			// 	//save new code
			// 	var elements = dummyElement.contentWindow.document.getElementsByTagName("img");
			// 	for (var i = 0;i < elements.length;++i) {

			// 			//check if item image
			// 			if (elements[i].width == "320" || elements[i].width == "640") {
			// 				elements[i].setAttribute("alt", item_names[i]);
			// 			}
			// 	}

			// 	new_code = dummyElement.contentWindow.document.body.innerHTML;
			// }

			function download() {
        var blob = new Blob([tagList.value], { type: "text/plain;charset=utf-8" });
        saveAs(blob, "tags.txt");
			}
		</script>

	</body>
</html>
