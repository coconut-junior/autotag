<!DOCTYPE html>
<html>
	<head>
		<meta charset=UTF-8>
		<title>Jimmy's Alt Tag Automator Beta 1.0</title>
		<script
			  src="https://code.jquery.com/jquery-3.6.0.js"
			  integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
			  crossorigin="anonymous">
			</script>
			<script src = "https://cdn.jsdelivr.net/npm/xlsx@0.14.3/dist/xlsx.full.min.js"></script>
			<link rel = "stylesheet" href = "stylesheet.css">
	</head>
	<body>

		<h1>Jimmy's Tag Automator Beta 1.0</h1>
		<div style = "display:flex;">
			<div class = "file-selectors">
				<input type="file" id = "html_browser" onchange="openHTML()" value = "Select HTML">
				<input type="file" id = "xls_browser" onchange="openSheet()" value = "Select INDD">
			</div>
			<iframe id = "preview" height = "640" width = "480"></iframe>
			<textarea id = "tagBox"></textarea>
			<button onclick = "autotag()">TAG IT!</button>
			<textarea id = "tagList"></textarea>

		</div>

		<script>

			//INSTRUCTIONS: export xls from Badger Feature View
			var file_text = "";
			var html_text = "";
			var alt_tags = [];
			var item_names = [];
			var matched_items = [];
			var prices = []; //maybe pull prices and other info from item lists xls?
			var workbook;
			var sheetName;
			var sheet;
				//open file


			function openSheet() {
				const [file] = document.getElementById("xls_browser").files;
			  const reader = new FileReader();
				var data = "";

			  reader.addEventListener("load", () => {
			    // this will then display a text file
			    data = reader.result;
					var options = { type: 'array' };
    			workbook = XLSX.read(data, options);
					sheetName = workbook.SheetNames;
    			sheet = workbook.Sheets["featureViewTable"];

					if(sheetName[0] != "featureViewTable") {
						alert("Ensure you are using a feature view table exported from Badger.")
					}
			  }, false);

			  if (file) {
			    reader.readAsArrayBuffer(file);
			  }
			}

			function openHTML() {
			  const [file] = document.getElementById("html_browser").files;
			  const reader = new FileReader();

			  reader.addEventListener("load", () => {
			    // this will then display a text file
			    html_text = reader.result;
					dummyElement.contentWindow.document.write(html_text);
			  }, false);

			  if (file) {
			    reader.readAsText(file);
			  }
			}

			var dummyElement = document.getElementById("preview");

			function autotag() {
				dummyElement.src = "";
				var new_code = "";
				var images = [];
				var tagIndex = 0;
				var tagBox = document.getElementById("tagBox");
				var last_item = "";
				tagBox.value = "";

				//these are all images
				var elements = dummyElement.contentWindow.document.getElementsByTagName("img");



				var range = XLSX.utils.decode_range(sheet['!ref']);
				matched_items = [];

				//search excel sheet for matches
				for (let rowNum = range.s.r + 1; rowNum <= range.e.r; rowNum++) {
						var iname = sheet[XLSX.utils.encode_cell({r: rowNum, c: 3})];
						var prices = sheet[XLSX.utils.encode_cell({r:rowNum,c:10})]["v"];
						iname = iname["v"].replace(" (logo) "," ");
						var complete_tag = iname + ": " + prices + ".";
						complete_tag = complete_tag.replaceAll("rice:","rice: $");

						for (var i = 0;i<item_names.length;++i)  {
							if (last_item != iname) {
								//match by size
								if (iname.includes("in ") || iname.includes("\"")) {
									item_names[i] = complete_tag;
									matched_items.push(complete_tag);
									last_item = iname;
								}
								//match by containing name

								if (iname.toLowerCase().includes(item_names[i].toLowerCase())) {
									//build alt tag

									item_names[i] = complete_tag;
									matched_items.push(complete_tag);
									last_item = iname;
								}
							}
						}

				}

				//list out matched items, remove duplicates

				for (var i = 0;i < matched_items.length;++i) {
					console.log(matched_items[i]);
						var prettyTag = matched_items[i];
						document.getElementById("tagList").value += prettyTag + "\n";
				}

				console.log(item_names);

				//insert alt tags
				for (var i = 0;i < elements.length;++i) {

						//check if item image
						if (elements[i].width == "320" || elements[i].width == "640") {
							elements[i].setAttribute("alt", alt_tags[tagIndex]);
							var path = elements[i].src.toString().split("/");
							var item_name = path[path.length-1].replace(".png","").replace("_"," ").replace("320x220","").replace("640x100","").replace("640x200","");
							//	+ ": OUR PRICE " + ", theirs " + ".";
							item_name = item_name.charAt(0).toUpperCase() + item_name.slice(1);

							//remove duplicates
							if (item_name != last_item && !item_name.includes("full")) {
								item_names.push(item_name);
								tagBox.value += item_name + "\n";
							}

							last_item = item_name;
							++tagIndex;
						}

				}

				//save new code
				new_code = dummyElement.contentWindow.document.body.innerHTML;
			}
		</script>

	</body>
</html>
