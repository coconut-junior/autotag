<!DOCTYPE html>
<html>
	<head>
		<meta charset=UTF-8>
		<title>Jimmy's Alt Tag Automator Beta 1.1</title>
		<script
			  src="https://code.jquery.com/jquery-3.6.0.js"
			  integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
			  crossorigin="anonymous">
			</script>
			<script src = "https://cdn.jsdelivr.net/npm/xlsx@0.14.3/dist/xlsx.full.min.js"></script>
			<link rel = "stylesheet" href = "stylesheet.css">
	</head>
	<body>

		<h1>Jimmy's Tag Automator Beta 1.1</h1>
		<div class = "wrapper">

			<div class = "file-selectors">
				<div id="drop_zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
			  	<p>Drop HTML here ...</p>
				</div>

				<div id="drop_zone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
			  	<p>Drop XLS here ...</p>
				</div>
				
			</div>
			<iframe id = "preview" height = "320" width = "480"></iframe>
			<textarea id = "tagBox"></textarea>
			<button onclick = "tagIt()" id = "tagButton" disabled>TAG IT!</button>
			<button onclick = "download()" id = "tagButton">Download</button>
			<textarea id = "tagList"></textarea>

		</div>

		<script>
		function dropHandler(ev) {
			console.log('File(s) dropped');

			// Prevent default behavior (Prevent file from being opened)
			ev.preventDefault();

			if (ev.dataTransfer.items) {
				// Use DataTransferItemList interface to access the file(s)
				for (var i = 0; i < ev.dataTransfer.items.length; i++) {
					// If dropped items aren't files, reject them
					if (ev.dataTransfer.items[i].kind === 'file') {
						var file = ev.dataTransfer.items[i].getAsFile();
						console.log('... file[' + i + '].name = ' + file.name);
						var files = ev.dataTransfer.files;

						if (file.name.includes(".html")) {
							openHTML(file);
						}
						else if (file.name.includes(".xls")) {
							openSheet(file);
						}

					}
				}
			} else {
				// Use DataTransfer interface to access the file(s)
					for (var i = 0; i < ev.dataTransfer.files.length; i++) {

					}
				}
			}

			function dragOverHandler(ev) {
			  console.log('File(s) in drop zone');

			  // Prevent default behavior (Prevent file from being opened)
			  ev.preventDefault();
			}


		</script>

		<script>

			//INSTRUCTIONS: export xls from Badger Feature View
			//Select html and xlsx
			//click 'tag it!'
			//download new html or copy tags over

			//compatibility: tested and working on safari and firefox

			var file_text = "";
			var html_text = "";
			var alt_tags = [];
			var item_names = [];
			var matched_items = [];
			var prices = []; //maybe pull prices and other info from item lists xls?
			var workbook;
			var sheetName;
			var sheet;
				//open file

			function tagIt() {
				autotag();
				autotag();
			}


			function openSheet(file) {
				//const [file] = document.getElementById("xls_browser").files;
			  const reader = new FileReader();
				var data = "";

			  reader.addEventListener("load", () => {
			    // this will then display a text file
			    data = reader.result;
					var options = { type: 'array' };
    			workbook = XLSX.read(data, options);
					sheetName = workbook.SheetNames;
    			sheet = workbook.Sheets["featureViewTable"];

					if(sheetName[0] != "featureViewTable") {
						alert("Ensure you are using a feature view table exported from Badger.")
					}
			  }, false);

			  if (file) {
			    reader.readAsArrayBuffer(file);
					document.getElementById("tagButton").disabled = false;
			  }
			}

			function openHTML(file) {
				console.log("opening html");
			  //const [file] = document.getElementById("html_browser").files;
			  const reader = new FileReader();

			  reader.addEventListener("load", () => {
			    // this will then display a text file
			    html_text = reader.result;
					dummyElement.contentWindow.document.write(html_text);
			  }, false);

			  if (file) {
			    reader.readAsText(file);
			  }
			}

			var dummyElement = document.getElementById("preview");

			function autotag() {
				dummyElement.src = "";
				var new_code = "";
				var images = [];
				var tagIndex = 0;
				var tagBox = document.getElementById("tagBox");
				var last_item = "";
				tagBox.value = "";

				var range = XLSX.utils.decode_range(sheet['!ref']);
				matched_items = [];

				//search excel sheet for matches
				for (let rowNum = range.s.r + 1; rowNum <= range.e.r; rowNum++) {
						var iname = sheet[XLSX.utils.encode_cell({r: rowNum, c: 3})];
						var prices = sheet[XLSX.utils.encode_cell({r:rowNum,c:10})]["v"];
						var special_notes = sheet[XLSX.utils.encode_cell({r:rowNum,c:11})]["v"];

						//fix prices if in special notes
						if (prices == "" && special_notes.toLowerCase().includes("price")) {
							console.log("special notes located");
							prices = special_notes;
						}

						iname = iname["v"].replace(" (logo) "," ");
						var complete_tag = iname + ": " + prices + ".";
						complete_tag = complete_tag.replaceAll("rice:","rice: $");

						for (var i = 0;i<item_names.length;++i)  {
							if (last_item != iname) {
								//match by size
								if (iname.includes("in ") || iname.includes("\"")) {
									item_names[i] = complete_tag;
									matched_items.push(complete_tag);
									last_item = iname;
								}

								//combined words? ex: water color, watercolor
								if (iname.toLowerCase().includes(item_names[i].toLowerCase().replaceAll(" ","")) ||
							item_names[i].toLowerCase().includes(iname.toLowerCase().replaceAll(" ",""))) {
									item_names[i] = complete_tag;
									matched_items.push(complete_tag);
									last_item = iname;
								}

								if (iname.toLowerCase().includes(item_names[i].toLowerCase())) {
									//match by containing name
									item_names[i] = complete_tag;
									matched_items.push(complete_tag);
									last_item = iname;
								}

								//match by last word in description
								var split_name = iname.toLowerCase().split(" ");
								if (item_names[i].includes(split_name[split_name.length-1]) && last_item!=iname) {

									item_names[i] = complete_tag;
									matched_items.push(complete_tag);
									last_item = iname;
									console.log("split name located");
								}
							}
						}

				}

				//add matched items to textarea for copying
				for (var i = 0;i < matched_items.length;++i) {
						var prettyTag = matched_items[i];
						document.getElementById("tagList").value += prettyTag + "\n";
				}

				//read image names
				var elements = dummyElement.contentWindow.document.getElementsByTagName("img");
				for (var i = 0;i < elements.length;++i) {

						//check if item image
						if (elements[i].width == "320" || elements[i].width == "640") {
							elements[i].setAttribute("alt", alt_tags[tagIndex]);
							var path = elements[i].src.toString().split("/");
							var item_name = path[path.length-1].replace(".png","").replaceAll("_"," ").replace("320x220","").replace("640x100","").replace("640x200","").trim();
							//	+ ": OUR PRICE " + ", theirs " + ".";
							item_name = item_name.charAt(0).toUpperCase() + item_name.slice(1);

							//remove duplicates
							if (item_name != last_item && !item_name.includes("full")) {
								item_names.push(item_name);
								tagBox.value += item_name + "\n";
							}

							last_item = item_name;
							++tagIndex;
						}

				}

				//these are ordered, matched items are unordered
				console.log(item_names);

				//save new code
				var elements = dummyElement.contentWindow.document.getElementsByTagName("img");
				for (var i = 0;i < elements.length;++i) {

						//check if item image
						if (elements[i].width == "320" || elements[i].width == "640") {
							elements[i].setAttribute("alt", item_names[i]);
						}
				}

				new_code = dummyElement.contentWindow.document.body.innerHTML;
				console.log(new_code);
			}
		</script>

	</body>
</html>
